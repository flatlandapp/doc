# 2.3 数学模型：行为验证

TW 协议的关键在于其严谨的数学模型，确保了 AI 代理生成的行为的真实性、合法性和一致性。

## 2.3.1 行为签名

每个行为 $A_i$ 由玩家的私钥签名生成，签名函数定义为：

$$S_i = \text{Sign}(A_i, K_{priv})$$

其中：
- $A_i$ 是行为数据，包括行为类型、参数和时间戳
- $K_{priv}$ 是玩家的私钥
- $S_i$ 是行为的数字签名

智能合约通过玩家的公钥 $K_{pub}$ 验证签名的合法性：

$$\text{Verify}(S_i, A_i, K_{pub}) = \text{True} \iff \text{签名有效}$$

## 2.3.2 行为合法性验证

行为 $A_i$ 的合法性由三个方面共同决定：

1. **规则一致性函数 $R(A_i)$**：
   验证行为是否符合游戏规则，定义为：

   $$R(A_i) = \text{True} \quad \text{如果 } A_i \text{ 符合游戏规则}$$
   $$R(A_i) = \text{False} \quad \text{其他情况}$$

2. **状态一致性函数 $S(A_i)$**：
   验证行为是否与角色当前状态一致，定义为：

   $$S(A_i) = \text{True} \quad \text{如果 } A_i \text{ 符合角色当前状态}$$
   $$S(A_i) = \text{False} \quad \text{其他情况}$$

3. **时序一致性函数 $T(A_i)$**：
   验证行为的时间戳是否合理，定义为：

   $$T(A_i) = \text{True} \quad \text{如果 } t_{A_i} > t_{last} \text{ 且 } t_{A_i} < t_{now} + \Delta t$$
   $$T(A_i) = \text{False} \quad \text{其他情况}$$

   其中 $t_{A_i}$ 是行为的时间戳，$t_{last}$ 是上一个行为的时间戳，$t_{now}$ 是当前时间，$\Delta t$ 是允许的时间误差。

行为 $A_i$ 的最终合法性判定为：

$$\text{Valid}(A_i) = R(A_i) \land S(A_i) \land T(A_i)$$

只有当 $\text{Valid}(A_i) = \text{True}$ 时，行为才会被应用到游戏世界。

## 2.3.3 行为熵与不确定性

为了确保 AI 代理生成的行为具有足够的多样性和不可预测性，TW 协议引入了行为熵的概念：

$$H(A) = -\sum_{i=1}^{n} p(a_i) \log_2 p(a_i)$$

其中：
- $H(A)$ 是行为集合 $A$ 的熵
- $p(a_i)$ 是行为 $a_i$ 的概率
- $n$ 是可能的行为总数

协议要求 AI 代理生成的行为熵不低于设定阈值 $H_{min}$：

$$H(A) \geq H_{min}$$

这确保了 AI 代理的行为不会过于确定性或可预测，增加了游戏的多样性和趣味性。
